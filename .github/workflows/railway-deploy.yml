name: Build and Deploy to Railway

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn -B package --file pom.xml

      - name: Install Railway CLI
        run: |
          curl -sL https://raw.githubusercontent.com/railwayapp/cli/master/install.sh | sh

      - name: Login to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway login --apiKey $RAILWAY_TOKEN

      - name: Ensure uploads Volume exists (Railway)
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          # Attempt to create a volume named 'uploads' and mount it to the container path.
          # If the volume already exists the command may fail; ignore non-zero exit to continue.
          set -e
          echo "Checking Railway volumes..."
          # List volumes (if supported) - ignore failure
          railway volume list --projectId $RAILWAY_PROJECT_ID || true
          echo "Creating uploads volume (if not exists)..."
          railway volume create uploads --mountPath /usr/local/tomcat/uploads --size 1Gi --projectId $RAILWAY_PROJECT_ID || true

      - name: Deploy to Railway
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          # Deploy using Railway CLI. The project must exist and the token must have permission.
          railway up --projectId $RAILWAY_PROJECT_ID --detach

      - name: Done
        run: echo "Deployment triggered to Railway. Check Railway dashboard for build status."

# Required secrets:
# - RAILWAY_TOKEN: Railway API token with deploy permissions
# - RAILWAY_PROJECT_ID: Railway project id to deploy into
